
TIM EQU  07D0H

MC1  EQU  0EE8H;1
MD1  EQU  0D54H;2
ME1  EQU  0BD6H;3
MF1  EQU  0B29H;4
MG1  EQU  09F7H;5
MA1  EQU  08E0H;6
MB1  EQU  07E8H;7

MC2  EQU  0778H;1`
MD2  EQU  06A7H;2`
ME2  EQU  05EDH;3`
MF2  EQU  0596H;4`
MG2  EQU  04FBH;5`
MA2  EQU  0470H;6`
MB2  EQU  03F4H;7`

DATA  SEGMENT
	
	SMG     DB    06H,5BH,4FH,66H,6DH,7DH,07H,7FH
	SMG1    DB    6FH,77H,0FFH,39H,0BFH,79H,71H,3FH;设置数码管
	GB		DW    MC1,MD1,ME1,MF1,MG1,MA1,MB1
	GBG1	DW    MC2,MD2,ME2,MF2,MG2,MA2,MB2
DATA  ENDS

CODE SEGMENT
	ASSUME	CS:CODE,DS:DATA

START:	
	MOV AX,CODE
	MOV CS,AX
	MOV AX,DATA
	MOV DS,AX

	MOV DX,0A006H	;初始化8253计时器
	MOV AX,36H	    ;计时器0，方式3，二进制   00110110
	OUT DX,AL

;8250初始化
    MOV DX,9006H;线路控制寄存器
	MOV AL,80H;10000000,为1的是dlab标志位
	OUT DX,AL;往线路控制器LCR中写DLAB=1
	
	MOV DX,9000H  ;除数锁存器低字节
	MOV AL,30H;110000
	OUT DX,AL
	;除数等于工作频率除以16与波特率的乘积，这里波特率设为了2400
	MOV DX,9002H;除数锁存器高字节
	MOV AL,0
	OUT DX,AL
	
	MOV DX,9006H 
	MOV AL,3 ;设置传送位数为八位
	OUT DX,AL 

CHECK1:

;8255初始化
	MOV DX,8006H
	MOV AL,89H;10001001  a组方式0，输出，高位c输入，b组方式0，输出，低位c输入
	OUT DX,AL
RECV:
	MOV DX,900AH;线路状态寄存器      
	IN AL,DX            
	TEST AL,1;检测接收数据是否准备好
	JZ RECV   
	MOV DX,9000H ;接收缓冲寄存器
	IN AL,DX
	MOV AH,AL

CP1:		CMP AH,'1'
			MOV AL,77H
			JZ DIS
CP2:		CMP AH,'2'
			MOV AL,7BH
			JZ DIS
CP3:		CMP AH,'3'
			MOV AL,7DH
			JZ DIS
CP4:		CMP AH,'4'
			MOV AL,7EH
			JZ DIS
CP5:		CMP AH,'5'
			MOV AL,0B7H
			JZ DIS
CP6:		CMP AH,'6'
			MOV AL,0BBH
			JZ DIS
CP7:		CMP AH,'7'
			MOV AL,0BDH
			JZ DIS
CP8:		CMP AH,'A'
			MOV AL,0DBH
			JZ DIS
CP9:		CMP AH,'B'
			MOV AL,0DDH
			JZ DIS
CP10:	CMP AH,'C'
			MOV AL,0DEH
			JZ DIS
CP11:	CMP AH,'D'
			MOV AL,0E7H
			JZ DIS
CP12:	CMP AH,'E'
			MOV AL,0EBH
			JZ DIS
CP13:	CMP AH,'F'
			MOV AL,0EDH
			JZ DIS
CP14:	CMP AH,'G'
			MOV AL,0D7H
			JZ DIS

DIS:			    ;八位七段数码管显示
	LEA SI,GB
	LEA DI,SMG
	CMP AL,77H
	JZ SOD
	
	ADD DI,1
	ADD SI,2
	CMP AL,7BH
	JZ SOD

	ADD DI,1
	ADD SI,2
	CMP AL,7DH
	JZ SOD

	ADD DI,1
	ADD SI,2
	CMP AL,7EH
	JZ SOD

	ADD DI,1
	ADD SI,2
	CMP AL,0B7H
	JZ SOD

	ADD DI,1
	ADD SI,2
	CMP AL,0BBH
	JZ SOD

	ADD DI,1
	ADD SI,2
	CMP AL,0BDH
	JZ SOD

	XOR SI,SI
	XOR DI,DI
	LEA SI,GBG1
	LEA DI,SMG1
	CMP AL,0D7H
	JZ SOD1
	
	ADD DI,1
	ADD SI,2
	CMP AL,0DBH
	JZ SOD1

	ADD DI,1
	ADD SI,2
	CMP AL,0DDH
	JZ SOD1

	ADD DI,1
	ADD SI,2
	CMP AL,0DEH
	JZ SOD1

	ADD DI,1
	ADD SI,2
	CMP AL,0E7H
	JZ SOD1

	ADD DI,1
	ADD SI,2
	CMP AL,0EBH
	JZ SOD1

	ADD DI,1
	ADD SI,2
	CMP AL,0EDH
	JZ SOD1
	JMP CHECK1

SOD:
	MOV DX,8002H
	MOV AL,[DI]
	OUT DX,AL
	CALL DELAY
	XOR AL,AL
	MOV DX,8000H	;输出GATE信号，开始发声
	MOV AL,01H	    ;PA0为GATE控制信号
	OUT DX,AL
	MOV BX,[SI]
	MOV DX,0A000H	;初始化8253计数器
	MOV AX,BX	    ;设置初值
	OUT DX,AL
	MOV AL,AH
	OUT DX,AL
	CALL DELAY	    ;设置发声时长
	MOV DX,8000H
	MOV AX,0H
	OUT DX,AL
	JMP CHECK1

SOD1:
	MOV DX,8002H
	MOV AL,[DI]
	OUT DX,AL
	CALL DELAY
	XOR AL,AL
	MOV DX,8000H	;输出GATE信号，开始发声
	MOV AL,01H	    ;PA0为GATE控制信号
	OUT DX,AL
	MOV BX,[SI]
	MOV DX,0A000H	;初始化8253计数器
	MOV AX,BX	    ;设置初值
	OUT DX,AL
	MOV AL,AH
	OUT DX,AL
	CALL DELAY	    ;设置发声时长
	MOV DX,8000H
	MOV AX,0H
	OUT DX,AX
	JMP CHECK1

DELAY:
	 MOV CX,TIM	   ;延迟时间
	LOOP $
	RET
DELAY1:
	 MOV CX,BX
	 LOOP $
	 RET
CODE ENDS
	END START
	